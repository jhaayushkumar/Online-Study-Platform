name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci):.+ ]]; then
          echo "PR title must follow conventional commits format"
          echo "Examples: feat: add new feature, fix: resolve bug"
          exit 1
        fi
        echo "PR title is valid"
    
    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
          echo "Merge conflicts detected"
          exit 1
        fi
        echo "No merge conflicts"
    
    - name: Check file changes
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        echo "Files changed: $FILES_CHANGED"
        if [ $FILES_CHANGED -gt 50 ]; then
          echo "Warning: Large PR with $FILES_CHANGED files changed"
        fi
    
    - name: PR Summary
      run: |
        echo "### PR Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files Changed**: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commits**: $(git rev-list --count origin/${{ github.base_ref }}..HEAD)" >> $GITHUB_STEP_SUMMARY
